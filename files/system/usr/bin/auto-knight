#!/bin/bash

# Name: auto-knight
# Description: This script automatically changes the global theme of KDE Plasma based on the time of day.
# It utilizes KDE's built-in Night Light feature to determine whether it is day or night.
# The script is intended to be run on startup.
# Author: Dmitriy Safiullin
# Date: 20204.03.16

set -euo pipefail

# Theme and command settings
light_colorscheme="LeafLight"
dark_colorscheme="LeafDark"

# Function to set the theme and update state
set_theme() {
    if [[ $1 == "light" ]]; then
        colorscheme=$light_colorscheme
    elif [[ $1 == "dark" ]]; then
        colorscheme=$dark_colorscheme
    fi
    plasma-apply-colorscheme $colorscheme
    last_theme=$1
}

# Gets current daylight status
is_daylight() {
    daylight_status=$(qdbus org.kde.KWin /org/kde/KWin/NightLight org.kde.KWin.NightLight.daylight)
    [[ "$daylight_status" == "true" ]]
}

# Initialize the theme based on the current daylight status
if is_daylight; then
    set_theme "light"
else
    set_theme "dark"
fi

# Monitor changes in daylight status and update the theme accordingly
dbus-monitor --session "type='signal',interface='org.freedesktop.DBus.Properties', member='PropertiesChanged', path='/org/kde/KWin/NightLight'" |
    grep --line-buffered "daylight" |
    while read -r line; do
        # Updates the theme if it needs to be changed
        if is_daylight; then
            theme="light"
        else
            theme="dark"
        fi
        if [[ "$last_theme" != "$theme" ]]; then
            set_theme "$theme"
        fi
    done
